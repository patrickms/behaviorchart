<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Your page title</title>

    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
    <!--
    See http://codepen.io/ashblue/pen/mCtuA for info on editable tables -->
    <script>
        
    	var today=Date.today();
        rootRef=new Firebase('https://behaviorchart.firebaseIO.com/');
        $( document ).ready(
            function()
            {
                var $TABLE = $('.pure-table');
                var $BTN = $('#update-btn');
                function compareStartTimes(a, b) {
                  if (today.at(a.startTime)<today.at(b.startTime)) {
                    return -1;
                  }
                  if (today.at(a.startTime)>today.at(b.startTime)) {
                    return 1;
                  }
                  // a must be equal to b
                  return 0;
                }
                
                function getTableData(){
                    var $rows = $TABLE.find('tbody').find('tr:not(:hidden)');
                  var headers = [];
                  var data = [];
                  
                  // Turn all existing rows into a loopable array
                  $rows.each(function () {
                    var h = {};
                    var stime = $(this).find('.starttime');
                    h.startTime = stime[0].textContent;
                    h.activityTitle=$(this).find('.activitytitle')[0].textContent;
                    h.electronicsAllowed=$(this).find('.electronicsallowed')[0].value.toLowerCase().startsWith('y');
                    h.preconditionsMet=$(this).find('.preconditionsmet')[0].checked;
                    data.push(h);
                  });
                  data.sort(compareStartTimes);
                  return data;
                }
                
                function setTableData(val){
                    var $rows = $TABLE.find('tbody').find('tr:not(:hidden)');
                    $rows.detach();
                    if(val)
                    {
                        val.sort(compareStartTimes);
                        val.forEach(function(rowValue, index){
                            var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide table-line');
                            $clone.find('.starttime')[0].textContent=rowValue.startTime;
                            $clone.find('.activitytitle')[0].textContent=rowValue.activityTitle;
                            $clone.find('.electronicsallowed')[0].value=rowValue.electronicsAllowed?"Yes":"No";
                            $clone.find('.preconditionsmet')[0].checked=rowValue.preconditionsMet;
                            $TABLE.find('tbody').append($clone);
                        });
                    }
                };

                rootRef.authWithOAuthPopup("google", function(error, authData) {
                  if (error) {
                    console.log("Login Failed!", error);
                  } else {
                        console.log("Authenticated successfully with payload:", authData);
                        timetableRef = rootRef.child('timetable');
                        $('.table-add').click(function () {
                          var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide table-line');
                          $TABLE.find('tbody').append($clone);
                        });
                        
                        $('.table-remove').click(function () {
                          $(this).parents('tr').detach();
                        });
                        $BTN.click(function () {
                              var data=getTableData();                              
                              //Send the output to firebase
                              timetableRef.set(data);
                              // Output the result
                              console.log('data',data);
                        });
                        
                      timetableRef.on('value', function(dataSnapshot) {
                        // code to handle new value.
                        val=dataSnapshot.val();  
                        setTableData(val);
                      });
                }
                });
        });

    </script>
    
    <style>
        .hide{
            display:none;
        }
    </style>
</head>

<body>
    <!--
    Your HTML goes here. Visit purecss.io/layouts/ for some sample HTML code.
    -->
    
<table class="pure-table pure-table-horizontal" style="width:100%">
    <thead>
        <tr>
            <th>Start Time</th>
            <th>Title</th>
            <th>Electronics Allowed</th>
            <th>Preconditions met</th>
            <th>&nbsp;</th>
            <th style="font-weight:normal;"><span class="table-add">&#10133;</span></th>
        </tr>
    </thead>

    <tbody>
        <tr class="hide">
            <td class="starttime" contenteditable="true">11:59PM</td>
            <td class="activitytitle" contenteditable="true">Bed</td>
            <td><select class="electronicsallowed" value="No">
                <option>Yes</option>
                <option>No</option>
            </select></td>
            <td><input class="preconditionsmet" type="checkbox"></input></td>
            <td><span class="table-remove">&#10006;</span></td>
            <td></td>
        </tr>
    </tbody>
</table>
<p>
    <button id="update-btn" class="btn btn-primary">Update Schedule</button> 
</p>

</body>
</html>
